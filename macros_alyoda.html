<CONTENT VERSION="1.0" LANG="fr" CHARSET="utf-8"/>

/**
 * ALYODA : NOUVELLES MACROS
 * =========================
 */

/**
 * Création de variables avec les index liés à l'arrêt.
 */
<DEFMACRO NAME="ALYODA_ARRETS_ENTRIES">
	<LET ARRAY="arret_entries" GLOBAL="1"></LET>
	<LOOP NAME="alyoda_arrets_entries" 
		TABLE="relations, entries, entrytypes" 
		SELECT="DISTINCT(idtype), title, altertitle, type AS entrytype" 
		WHERE="id1 = '[#ID]' AND id2 = entries.id AND entries.idtype = entrytypes.id AND entrytypes.class = 'indexes'">
		<LET ARRAY="arret_entries.#ENTRYTYPE" GLOBAL="1">
			<LOOP NAME="alyoda_arrets_entries_item" 
				TABLE="entries" SELECT="id, g_name" 
				WHERE="idtype = '[#IDTYPE]' AND iddocument = '[#ID]'" 
				ORDER="degree">
				<IF COND="[#COUNT] GT 1">, </IF><a href="[#ID|makeurlwithid]">[#G_NAME]</a>
			</LOOP>
		</LET>
	</LOOP>
	<LET VAR="juridictions">[%ARRET_ENTRIES.JURIDICTIONS]</LET>
	<LET VAR="lebon">[%ARRET_ENTRIES.LEBON]</LET>
</DEFMACRO>

/**
 * Sous-titre de la décision dans le sommaire des publications.
 */
<DEFMACRO NAME="ALYODA_SOUSTITRE_DECISION">
	<LOOP NAME="alyoda_soustitre_decision" TABLE="arrets" WHERE="idparent= '[#ID]'" SELECT="id, numero, numerolegifrance, date" ORDER="rank">
		<!--[ Récupérer les index dans des variables ]-->
		<MACRO NAME="ALYODA_ARRETS_ENTRIES"/>
		<p class="toc__subtitle">[#JURIDICTIONS|textebrut] – N°&nbsp;[#NUMERO] – [#DATE|humandate] – [#LEBON|textebrut]</p>
	</LOOP>
</DEFMACRO>

/**
 * ALYODA : SURCHARGES DE LA NOVA
 * ==============================
 */

/**
 * Affiche le titre, le sous-titre d'un document avec la mention "texte intégral", et le numéro du doc.
 * EDIT: Prise en compte des document de la classe decisions + option affichage d'un extrait du texte.
 * @param {boolean} [afficher_soustitre] - Affichage du sous-titre.
 * @param {boolean} [afficher_titres_traduits] - Affichage des titres traduits.
 * @param {boolean} [afficher_datepubli] - Affichage de la date de publication.
 */
<DEFFUNC NAME="PUBLICATION_LI_DOCUMENT" OPTIONAL="afficher_soustitre, afficher_titres_traduits, afficher_datepubli">
	<a class="toc__link" href="[#ID|makeurlwithid]">
		<!--[ Titre ]-->
		<p class="toc__title">[#TITRE|removenotes]</p>
		
		<!--[ Sous-titre ]-->
		<IF COND="[#AFFICHER_SOUSTITRE]">
			<IF COND="[#SOUSTITRE]">
				<p class="toc__subtitle">[#SOUSTITRE|removenotes]</p>
			<ELSEIF COND="[#TYPE] EQ 'decisiondejustice'">
				<MACRO NAME="ALYODA_SOUSTITRE_DECISION"/>
			</IF>
		</IF>
		
		<!--[ Titres traduits]-->
		<IF COND="[#AFFICHER_TITRES_TRADUITS] AND [#ALTERTITRE] LIKE /<r2r:ml lang=\" ([a-z]+)\"/"> 
			<div class="toc__altertitle">
				<LOOP NAME="foreach" ARRAY="[#MATCHES.1]">
					<p xml:lang="[#VALUE]" lang="[#VALUE]">[#ALTERTITRE:#VALUE|removenotes]</p>
				</LOOP>
			</div>
		</IF>

		<!--[ Date de publication si publié dans une rubrique électronique ]-->
		<IF COND="[#AFFICHER_DATEPUBLI]">
			<p class="toc__datepubli">[#DATEPUBLI|humandate]</p>
		</IF>

		<!--[ Affichage d'un extrait du texte ]-->
		<IF COND="[#TYPE] EQ 'decisiondejustice'">
			<p class="toc__extrait">[#TEXTE|removenotes|textebrut|cuttext(220, true)]</p>
		</IF>
	</a>
</DEFFUNC>

/**
 * Affiche le titre d'une publication.
 * @param {string} [separator] - Caractère séparant le numéro et le titre d'une publication.
 * @param {boolean} [textebrut] - Afficher sans balises HTML.
 * @param {boolean} [cliquable] - Afficher avec un lien.
 * @param {boolean} [ml] - Afficher le titre traduit s'il est disponible.
 * EDIT: n'afficher que le titre du numéro.
 */
<DEFFUNC NAME="BASE_TITRE_PUBLICATION" OPTIONAL="separator, textebrut, cliquable, ml">
	<IF COND="[#TEXTEBRUT]">
		<IF COND="[#NUMERO]">
			[#TITRE|textebrut]
		<ELSEIF COND="[#TYPE] EQ 'rubriqueannuelle'"/>
			<LOOP NAME="base_titre_publication_parent_title_brut" SELECT="titre" TABLE="publications" WHERE="id = '[#IDPARENT]'">[#TITRE|textebrut] | </LOOP>
			[#TITRE|textebrut]
		<ELSEIF COND="[#ML]"/>
			<LET VAR="mlt"><FUNC NAME="BASE_ML_TITRE" /></LET>
			[#MLT|textebrut]
		<ELSE/>
			[#TITRE|textebrut]
		</IF>
	<ELSE/>
		<IF COND="[#CLIQUABLE]">
			<a href="[#ID|makeurlwithid]">
		</IF>
		<IF COND="[#NUMERO]">
			<!--[ Support de la direction du texte ]-->
			<IF COND="[#TITRE|text_is_rtl]">
				<LET VAR="dir_titre"><span dir="rtl">[#TITRE]</span></LET>
			<ELSE />
				<LET VAR="dir_titre">[#TITRE]</LET>
			</IF>
			<span class="publi-title-text">[#DIR_TITRE]</span>
		<ELSEIF COND="[#TYPE] EQ 'rubriqueannuelle'"/>
			<span class="publi-title-text"><LOOP NAME="base_titre_publication_parent_title" SELECT="titre" TABLE="publications" WHERE="id = '[#IDPARENT]'">[#TITRE] | </LOOP>[#TITRE]</span>
		<ELSEIF COND="[#ML]"/>
			<span class="publi-title-text"><FUNC NAME="BASE_ML_TITRE" /></span>
		<ELSE/>
			<span class="publi-title-text">[#TITRE]</span>
		</IF>
		<IF COND="[#CLIQUABLE]">
			</a>
		</IF>
	</IF>
</DEFFUNC>

/**
 * Affiche une liste de numéros pour le menu.
 * @param {string} titre_section - Titre de la section du menu.
 * @param {int} id_collection - ID de la collection parente.
 * @param {string} [filtre] - Filtre passé dans le WHERE de la requête.
 * EDIT: n'afficher que le titre du numéro.
 */
<DEFFUNC NAME="MENU_ISSUES_ITEMS" REQUIRED="titre_section, id_collection" OPTIONAL="filtre">
	<IF COND="![%MENU_MAX_ISSUES]">
		<LET VAR="menu_max_issues" GLOBAL="1">10</LET>
	</IF>

	<LOOP NAME="menu_issues_items" 
		TABLE="publications"
		SELECT="id, numero, titre, altertitre, periode, datepubli, datepublipapier"
		WHERE="idparent = '[#ID_COLLECTION]' [#FILTRE]"
		ORDER="rank DESC"
		LIMIT="[%MENU_MAX_ISSUES]">
		<BEFORE>
			<section class="main-menu__section main-menu__section--issues">
				<h2 class="main-menu__section-title">[#TITRE_SECTION]</h2>
				<ul class="main-menu__list">
		</BEFORE>
		<DO>
			<li class="main-menu__item main-menu__item--issue">
				<a href="[#ID|makeurlwithid]">
					<LET VAR="ml_titre"><FUNC NAME="BASE_ML_TITRE" /></LET>
					<IF COND="[#ML_TITRE] NE [#NUMERO]"><div class="publi-title">[#ML_TITRE]</div></IF>
				</a>
			</li>
		</DO>
		<AFTER>
				</ul>
			</section>
		</AFTER>
	</LOOP>
</DEFFUNC>

/**
 * Affichage des textes et arrets associés à l'entrée.
 * EDIT: compatibilité avec le ME Alyoda.
 */
<DEFMACRO NAME="ENTREE_LISTE_TEXTES">
	<!--[ Remplir un array avec les documents liés ]-->
	<LET ARRAY="textes_array" GLOBAL="1"></LET>
	<LOOP NAME="entree_liste_textes_textes" 
		TABLE="textes" 
		SELECT="id, idparent"
		WHERE="identry='[#ID]' AND id [#NOT_IN_TRADUCTIONS]">
		<SWITCH TEST="[#TYPE]">
			<DO CASES="editorial, article, actualite, compterendu, notedelecture, informations, chronique, decisiondejustice">
				<LET ARRAY="textes_array[]" GLOBAL="1">[#ID]</LET>
			</DO>
			<DO CASE="default">
				<LET ARRAY="textes_array[]" GLOBAL="1">[#IDPARENT]</LET>
			</DO>
		</SWITCH>
	</LOOP>

	<LOOP NAME="entree_liste_textes_arrets" 
		TABLE="arrets" 
		SELECT="idparent"
		WHERE="identry='[#ID]'">
		<LET ARRAY="textes_array[]" GLOBAL="1">[#IDPARENT]</LET>
	</LOOP>

	<!--[ Afficher la liste sans les doublons ]-->
	<LOOP NAME="entree_liste_textes_afficher" 
		TABLE="textes" 
		WHERE="alias_entities_textes.id IN ([%TEXTES_ARRAY|array_unique|join(',')])" 
		ORDER="datepubli DESC">
		<BEFORE>
			<section id="entry-type" class="toc toc--entry">
				<ul class="toc__contents toc__contents--entry toc__contents--entry-class-[#TYPE.CLASS] toc__contents--entry-type-[#TYPE.TYPE]">
		</BEFORE>
		<DO>
			<li class="toc__li toc__li--class-textes">
				<FUNC NAME="PUBLICATION_LI_TEXTE"/>
			</li>
		</DO>
		<AFTER>
				</ul>
			</section>
		</AFTER>
	</LOOP>
</DEFMACRO>
