<CONTENT VERSION="1.0" LANG="fr" CHARSET="utf-8"/>

/**
 * ALYODA : NOUVELLES MACROS
 * =========================
 */

/**
 * Création de variables avec les index liés à l'arrêt.
 */
<DEFMACRO NAME="ALYODA_ARRETS_ENTRIES">
	<LET ARRAY="arret_entries" GLOBAL="1"></LET>
	<LOOP NAME="alyoda_arrets_entries" 
		TABLE="relations, entries, entrytypes" 
		SELECT="DISTINCT(idtype), title, altertitle, type AS entrytype" 
		WHERE="id1 = '[#ID]' AND id2 = entries.id AND entries.idtype = entrytypes.id AND entrytypes.class = 'indexes'">
		<LET ARRAY="arret_entries.#ENTRYTYPE" GLOBAL="1">
			<LOOP NAME="alyoda_arrets_entries_item" 
				TABLE="entries" SELECT="id, g_name" 
				WHERE="idtype = '[#IDTYPE]' AND iddocument = '[#ID]'" 
				ORDER="degree">
				<IF COND="[#COUNT] GT 1">, </IF><a href="[#ID|makeurlwithid]">[#G_NAME]</a>
			</LOOP>
		</LET>
	</LOOP>
	<LET VAR="juridictions">[%ARRET_ENTRIES.JURIDICTIONS]</LET>
	<LET VAR="lebon">[%ARRET_ENTRIES.LEBON]</LET>
</DEFMACRO>

/**
 * Sous-titre de la décision dans le sommaire des publications.
 */
<DEFMACRO NAME="ALYODA_SOUSTITRE_DECISION">
	<LOOP NAME="alyoda_soustitre_decision" TABLE="arrets" WHERE="idparent= '[#ID]'" SELECT="id, numero, numerolegifrance, date" ORDER="rank">
		<!--[ Récupérer les index dans des variables ]-->
		<MACRO NAME="ALYODA_ARRETS_ENTRIES"/>
		<p class="toc__subtitle">[#JURIDICTIONS|textebrut] – N°&nbsp;[#NUMERO] – [#DATE|humandate] – [#LEBON|textebrut]</p>
	</LOOP>
</DEFMACRO>

/**
 * ALYODA : SURCHARGES DE LA NOVA
 * ==============================
 */

/**
 * Affiche le titre, le sous-titre d'un document avec la mention "texte intégral", et le numéro du doc.
 * EDIT: Prise en compte des document de la classe decisions + option affichage d'un extrait du texte.
 * @param {boolean} [afficher_soustitre] - Affichage du sous-titre.
 * @param {boolean} [afficher_titres_traduits] - Affichage des titres traduits.
 * @param {boolean} [afficher_datepubli] - Affichage de la date de publication.
 */
<DEFFUNC NAME="PUBLICATION_LI_DOCUMENT" OPTIONAL="afficher_soustitre, afficher_titres_traduits, afficher_datepubli">
	<a class="toc__link" href="[#ID|makeurlwithid]">
		<!--[ Titre ]-->
		<p class="toc__title">[#TITRE|removenotes]</p>
		
		<!--[ Sous-titre ]-->
		<IF COND="[#AFFICHER_SOUSTITRE]">
			<IF COND="[#SOUSTITRE]">
				<p class="toc__subtitle">[#SOUSTITRE|removenotes]</p>
			<ELSEIF COND="[#TYPE] EQ 'decisiondejustice'">
				<MACRO NAME="ALYODA_SOUSTITRE_DECISION"/>
			</IF>
		</IF>
		
		<!--[ Titres traduits]-->
		<IF COND="[#AFFICHER_TITRES_TRADUITS] AND [#ALTERTITRE] LIKE /<r2r:ml lang=\" ([a-z]+)\"/"> 
			<div class="toc__altertitle">
				<LOOP NAME="foreach" ARRAY="[#MATCHES.1]">
					<p xml:lang="[#VALUE]" lang="[#VALUE]">[#ALTERTITRE:#VALUE|removenotes]</p>
				</LOOP>
			</div>
		</IF>

		<!--[ Date de publication si publié dans une rubrique électronique ]-->
		<IF COND="[#AFFICHER_DATEPUBLI]">
			<p class="toc__datepubli">[#DATEPUBLI|humandate]</p>
		</IF>

		<!--[ Affichage d'un extrait du texte ]-->
		<IF COND="[#TYPE] EQ 'decisiondejustice'">
			<p class="toc__extrait">[#TEXTE|removenotes|textebrut|cuttext(220, true)]</p>
		</IF>
	</a>
</DEFFUNC>

/**
 * Macro principale appelée par le template.
 */
<DEFMACRO NAME="ENTREE_MAIN">
	<MACRO NAME="ENTREE_TITLE" />
	<MACRO NAME="ENTREE_LISTE_TEXTES" />
	<MACRO NAME="AYODA_ENTREE_LISTE_ARRETS" />
	<MACRO NAME="ENTREE_RETOUR" />
</DEFMACRO>

/**
 * Affichage des arrets associés à l'entrée.
 */
<DEFMACRO NAME="AYODA_ENTREE_LISTE_ARRETS">
	<LOOP NAME="ayoda_entree_liste_arrets" 
		TABLE="arrets" 
		SELECT="id, numero, date"
		WHERE="identry='[#ID]'" 
		ORDER="numero">
		<BEFORE>
			<section id="entry-type" class="toc toc--entry">
				<ul class="toc__contents toc__contents--entry toc__contents--entry-class-[#TYPE.CLASS] toc__contents--entry-type-[#TYPE.TYPE]">
		</BEFORE>
		<DO>
			<li class="toc__li toc__li toc__li--class-arrets">
				<a href="[#ID|makeurlwithid]">[#NUMERO] ([#DATE|humandate])</a>
			</li>
		</DO>
		<AFTER>
				</ul>
			</section>
		</AFTER>
	</LOOP>
</DEFMACRO>
